import{h as we,V as Q,I as k,K as Me,N as S,T as Ae,G as x,W as B,X as Ee,Y as be,Z as H,f as Ie,q as Re,a0 as D,a1 as Ne,a2 as q,a3 as Le,B as Se,a4 as ve,a5 as _e,a6 as Fe,n as Ue,a7 as Ce,a8 as Oe,a9 as ze,aa as ke,ab as De,ac as Ge}from"./index-BgZPVzbu.js";Se();var W={POSITION:["byte","byte normalized","unsigned byte","unsigned byte normalized","short","short normalized","unsigned short","unsigned short normalized"],NORMAL:["byte normalized","short normalized"],TANGENT:["byte normalized","short normalized"],TEXCOORD:["byte","byte normalized","unsigned byte","short","short normalized","unsigned short"]},ee=class{constructor(){this.textureUtils=null,this.pluginCallbacks=[],this.register(function(e){return new Ke(e)}),this.register(function(e){return new Xe(e)}),this.register(function(e){return new Je(e)}),this.register(function(e){return new $e(e)}),this.register(function(e){return new Qe(e)}),this.register(function(e){return new et(e)}),this.register(function(e){return new qe(e)}),this.register(function(e){return new We(e)}),this.register(function(e){return new Ze(e)}),this.register(function(e){return new tt(e)}),this.register(function(e){return new st(e)}),this.register(function(e){return new rt(e)}),this.register(function(e){return new nt(e)}),this.register(function(e){return new it(e)})}register(e){return this.pluginCallbacks.indexOf(e)===-1&&this.pluginCallbacks.push(e),this}unregister(e){return this.pluginCallbacks.indexOf(e)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}setTextureUtils(e){return this.textureUtils=e,this}parse(e,t,s,r){let i=new Ye,n=[];for(let a=0,l=this.pluginCallbacks.length;a<l;a++)n.push(this.pluginCallbacks[a](i));i.setPlugins(n),i.setTextureUtils(this.textureUtils),i.writeAsync(e,t,r).catch(s)}parseAsync(e,t){let s=this;return new Promise(function(r,i){s.parse(e,r,i,t)})}};x(ee,"GLTFExporter");var V=ee,d={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,ARRAY_BUFFER:34962,ELEMENT_ARRAY_BUFFER:34963,NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987,CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,REPEAT:10497},P="KHR_mesh_quantization",I={};I[ve]=d.NEAREST;I[_e]=d.NEAREST_MIPMAP_NEAREST;I[Fe]=d.NEAREST_MIPMAP_LINEAR;I[Ue]=d.LINEAR;I[Ce]=d.LINEAR_MIPMAP_NEAREST;I[Oe]=d.LINEAR_MIPMAP_LINEAR;I[ze]=d.CLAMP_TO_EDGE;I[ke]=d.REPEAT;I[De]=d.MIRRORED_REPEAT;var Z={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"},Be=new we,J=12,Pe=1179937895,He=2,$=8,Ve=1313821514,je=5130562;function _(o,e){return o.length===e.length&&o.every(function(t,s){return t===e[s]})}x(_,"equalArray");function te(o){return new TextEncoder().encode(o).buffer}x(te,"stringToArrayBuffer");function se(o){return _(o.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}x(se,"isIdentityMatrix");function re(o,e,t){let s={min:new Array(o.itemSize).fill(Number.POSITIVE_INFINITY),max:new Array(o.itemSize).fill(Number.NEGATIVE_INFINITY)};for(let r=e;r<e+t;r++)for(let i=0;i<o.itemSize;i++){let n;o.itemSize>4?n=o.array[r*o.itemSize+i]:(i===0?n=o.getX(r):i===1?n=o.getY(r):i===2?n=o.getZ(r):i===3&&(n=o.getW(r)),o.normalized===!0&&(n=H.normalize(n,o.array))),s.min[i]=Math.min(s.min[i],n),s.max[i]=Math.max(s.max[i],n)}return s}x(re,"getMinMax");function K(o){return Math.ceil(o/4)*4}x(K,"getPaddedBufferSize");function z(o,e=0){let t=K(o.byteLength);if(t!==o.byteLength){let s=new Uint8Array(t);if(s.set(new Uint8Array(o)),e!==0)for(let r=o.byteLength;r<t;r++)s[r]=e;return s.buffer}return o}x(z,"getPaddedArrayBuffer");function j(){return typeof document>"u"&&typeof OffscreenCanvas<"u"?new OffscreenCanvas(1,1):document.createElement("canvas")}x(j,"getCanvas");function Y(o,e){if(o.toBlob!==void 0)return new Promise(s=>o.toBlob(s,e));let t;return e==="image/jpeg"?t=.92:e==="image/webp"&&(t=.8),o.convertToBlob({type:e,quality:t})}x(Y,"getToBlobPromise");var ne=class{constructor(){this.plugins=[],this.options={},this.pending=[],this.buffers=[],this.byteOffset=0,this.buffers=[],this.nodeMap=new Map,this.skins=[],this.extensionsUsed={},this.extensionsRequired={},this.uids=new Map,this.uid=0,this.json={asset:{version:"2.0",generator:"THREE.GLTFExporter r"+Ae}},this.cache={meshes:new Map,attributes:new Map,attributesNormalized:new Map,materials:new Map,textures:new Map,images:new Map},this.textureUtils=null}setPlugins(e){this.plugins=e}setTextureUtils(e){this.textureUtils=e}async writeAsync(e,t,s={}){this.options=Object.assign({binary:!1,trs:!1,onlyVisible:!0,maxTextureSize:1/0,animations:[],includeCustomExtensions:!1},s),this.options.animations.length>0&&(this.options.trs=!0),await this.processInputAsync(e),await Promise.all(this.pending);let r=this,i=r.buffers,n=r.json;s=r.options;let a=r.extensionsUsed,l=r.extensionsRequired,h=new Blob(i,{type:"application/octet-stream"}),p=Object.keys(a),c=Object.keys(l);if(p.length>0&&(n.extensionsUsed=p),c.length>0&&(n.extensionsRequired=c),n.buffers&&n.buffers.length>0&&(n.buffers[0].byteLength=h.size),s.binary===!0){let g=new FileReader;g.readAsArrayBuffer(h),g.onloadend=function(){let u=z(g.result),m=new DataView(new ArrayBuffer($));m.setUint32(0,u.byteLength,!0),m.setUint32(4,je,!0);let y=z(te(JSON.stringify(n)),32),w=new DataView(new ArrayBuffer($));w.setUint32(0,y.byteLength,!0),w.setUint32(4,Ve,!0);let A=new ArrayBuffer(J),R=new DataView(A);R.setUint32(0,Pe,!0),R.setUint32(4,He,!0);let O=J+w.byteLength+y.byteLength+m.byteLength+u.byteLength;R.setUint32(8,O,!0);let f=new Blob([A,w,y,m,u],{type:"application/octet-stream"}),T=new FileReader;T.readAsArrayBuffer(f),T.onloadend=function(){t(T.result)}}}else if(n.buffers&&n.buffers.length>0){let g=new FileReader;g.readAsDataURL(h),g.onloadend=function(){let u=g.result;n.buffers[0].uri=u,t(n)}}else t(n)}serializeUserData(e,t){if(Object.keys(e.userData).length===0)return;let s=this.options,r=this.extensionsUsed;try{let i=JSON.parse(JSON.stringify(e.userData));if(s.includeCustomExtensions&&i.gltfExtensions){t.extensions===void 0&&(t.extensions={});for(let n in i.gltfExtensions)t.extensions[n]=i.gltfExtensions[n],r[n]=!0;delete i.gltfExtensions}Object.keys(i).length>0&&(t.extras=i)}catch(i){console.warn("THREE.GLTFExporter: userData of '"+e.name+"' won't be serialized because of JSON.stringify error - "+i.message)}}getUID(e,t=!1){if(this.uids.has(e)===!1){let s=new Map;s.set(!0,this.uid++),s.set(!1,this.uid++),this.uids.set(e,s)}return this.uids.get(e).get(t)}isNormalizedNormalAttribute(e){if(this.cache.attributesNormalized.has(e))return!1;let t=new k;for(let s=0,r=e.count;s<r;s++)if(Math.abs(t.fromBufferAttribute(e,s).length()-1)>5e-4)return!1;return!0}createNormalizedNormalAttribute(e){let t=this.cache;if(t.attributesNormalized.has(e))return t.attributesNormalized.get(e);let s=e.clone(),r=new k;for(let i=0,n=s.count;i<n;i++)r.fromBufferAttribute(s,i),r.x===0&&r.y===0&&r.z===0?r.setX(1):r.normalize(),s.setXYZ(i,r.x,r.y,r.z);return t.attributesNormalized.set(e,s),s}applyTextureTransform(e,t){let s=!1,r={};(t.offset.x!==0||t.offset.y!==0)&&(r.offset=t.offset.toArray(),s=!0),t.rotation!==0&&(r.rotation=t.rotation,s=!0),(t.repeat.x!==1||t.repeat.y!==1)&&(r.scale=t.repeat.toArray(),s=!0),s&&(e.extensions=e.extensions||{},e.extensions.KHR_texture_transform=r,this.extensionsUsed.KHR_texture_transform=!0)}async buildMetalRoughTextureAsync(e,t){if(e===t)return e;function s(g){return g.colorSpace===Le?x(function(u){return u<.04045?u*.0773993808:Math.pow(u*.9478672986+.0521327014,2.4)},"SRGBToLinear"):x(function(u){return u},"LinearToLinear")}x(s,"getEncodingConversion"),e instanceof B&&(e=await this.decompressTextureAsync(e)),t instanceof B&&(t=await this.decompressTextureAsync(t));let r=e?e.image:null,i=t?t.image:null,n=Math.max(r?r.width:0,i?i.width:0),a=Math.max(r?r.height:0,i?i.height:0),l=j();l.width=n,l.height=a;let h=l.getContext("2d",{willReadFrequently:!0});h.fillStyle="#00ffff",h.fillRect(0,0,n,a);let p=h.getImageData(0,0,n,a);if(r){h.drawImage(r,0,0,n,a);let g=s(e),u=h.getImageData(0,0,n,a).data;for(let m=2;m<u.length;m+=4)p.data[m]=g(u[m]/256)*256}if(i){h.drawImage(i,0,0,n,a);let g=s(t),u=h.getImageData(0,0,n,a).data;for(let m=1;m<u.length;m+=4)p.data[m]=g(u[m]/256)*256}h.putImageData(p,0,0);let c=(e||t).clone();return c.source=new Ee(l),c.colorSpace=be,c.channel=(e||t).channel,e&&t&&e.channel!==t.channel&&console.warn("THREE.GLTFExporter: UV channels for metalnessMap and roughnessMap textures must match."),console.warn("THREE.GLTFExporter: Merged metalnessMap and roughnessMap textures."),c}async decompressTextureAsync(e,t=1/0){if(this.textureUtils===null)throw new Error("THREE.GLTFExporter: setTextureUtils() must be called to process compressed textures.");return await this.textureUtils.decompress(e,t)}processBuffer(e){let t=this.json,s=this.buffers;return t.buffers||(t.buffers=[{byteLength:0}]),s.push(e),0}processBufferView(e,t,s,r,i){let n=this.json;n.bufferViews||(n.bufferViews=[]);let a;switch(t){case d.BYTE:case d.UNSIGNED_BYTE:a=1;break;case d.SHORT:case d.UNSIGNED_SHORT:a=2;break;default:a=4}let l=e.itemSize*a;i===d.ARRAY_BUFFER&&(l=Math.ceil(l/4)*4);let h=K(r*l),p=new DataView(new ArrayBuffer(h)),c=0;for(let u=s;u<s+r;u++){for(let m=0;m<e.itemSize;m++){let y;e.itemSize>4?y=e.array[u*e.itemSize+m]:(m===0?y=e.getX(u):m===1?y=e.getY(u):m===2?y=e.getZ(u):m===3&&(y=e.getW(u)),e.normalized===!0&&(y=H.normalize(y,e.array))),t===d.FLOAT?p.setFloat32(c,y,!0):t===d.INT?p.setInt32(c,y,!0):t===d.UNSIGNED_INT?p.setUint32(c,y,!0):t===d.SHORT?p.setInt16(c,y,!0):t===d.UNSIGNED_SHORT?p.setUint16(c,y,!0):t===d.BYTE?p.setInt8(c,y):t===d.UNSIGNED_BYTE&&p.setUint8(c,y),c+=a}c%l!==0&&(c+=l-c%l)}let g={buffer:this.processBuffer(p.buffer),byteOffset:this.byteOffset,byteLength:h};return i!==void 0&&(g.target=i),i===d.ARRAY_BUFFER&&(g.byteStride=l),this.byteOffset+=h,n.bufferViews.push(g),{id:n.bufferViews.length-1,byteLength:0}}processBufferViewImage(e){let t=this,s=t.json;return s.bufferViews||(s.bufferViews=[]),new Promise(function(r){let i=new FileReader;i.readAsArrayBuffer(e),i.onloadend=function(){let n=z(i.result),a={buffer:t.processBuffer(n),byteOffset:t.byteOffset,byteLength:n.byteLength};t.byteOffset+=n.byteLength,r(s.bufferViews.push(a)-1)}})}processAccessor(e,t,s,r){let i=this.json,n={1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",9:"MAT3",16:"MAT4"},a;if(e.array.constructor===Float32Array)a=d.FLOAT;else if(e.array.constructor===Int32Array)a=d.INT;else if(e.array.constructor===Uint32Array)a=d.UNSIGNED_INT;else if(e.array.constructor===Int16Array)a=d.SHORT;else if(e.array.constructor===Uint16Array)a=d.UNSIGNED_SHORT;else if(e.array.constructor===Int8Array)a=d.BYTE;else if(e.array.constructor===Uint8Array)a=d.UNSIGNED_BYTE;else throw new Error("THREE.GLTFExporter: Unsupported bufferAttribute component type: "+e.array.constructor.name);if(s===void 0&&(s=0),(r===void 0||r===1/0)&&(r=e.count),r===0)return null;let l=re(e,s,r),h;t!==void 0&&(h=e===t.index?d.ELEMENT_ARRAY_BUFFER:d.ARRAY_BUFFER);let p=this.processBufferView(e,a,s,r,h),c={bufferView:p.id,byteOffset:p.byteOffset,componentType:a,count:r,max:l.max,min:l.min,type:n[e.itemSize]};return e.normalized===!0&&(c.normalized=!0),i.accessors||(i.accessors=[]),i.accessors.push(c)-1}processImage(e,t,s,r="image/png"){if(e!==null){let i=this,n=i.cache,a=i.json,l=i.options,h=i.pending;n.images.has(e)||n.images.set(e,{});let p=n.images.get(e),c=r+":flipY/"+s.toString();if(p[c]!==void 0)return p[c];a.images||(a.images=[]);let g={mimeType:r},u=j();u.width=Math.min(e.width,l.maxTextureSize),u.height=Math.min(e.height,l.maxTextureSize);let m=u.getContext("2d",{willReadFrequently:!0});if(s===!0&&(m.translate(0,u.height),m.scale(1,-1)),e.data!==void 0){t!==Ie&&console.error("GLTFExporter: Only RGBAFormat is supported.",t),(e.width>l.maxTextureSize||e.height>l.maxTextureSize)&&console.warn("GLTFExporter: Image size is bigger than maxTextureSize",e);let w=new Uint8ClampedArray(e.height*e.width*4);for(let A=0;A<w.length;A+=4)w[A+0]=e.data[A+0],w[A+1]=e.data[A+1],w[A+2]=e.data[A+2],w[A+3]=e.data[A+3];m.putImageData(new ImageData(w,e.width,e.height),0,0)}else if(typeof HTMLImageElement<"u"&&e instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&e instanceof HTMLCanvasElement||typeof ImageBitmap<"u"&&e instanceof ImageBitmap||typeof OffscreenCanvas<"u"&&e instanceof OffscreenCanvas)m.drawImage(e,0,0,u.width,u.height);else throw new Error("THREE.GLTFExporter: Invalid image type. Use HTMLImageElement, HTMLCanvasElement, ImageBitmap or OffscreenCanvas.");l.binary===!0?h.push(Y(u,r).then(w=>i.processBufferViewImage(w)).then(w=>{g.bufferView=w})):u.toDataURL!==void 0?g.uri=u.toDataURL(r):h.push(Y(u,r).then(w=>new FileReader().readAsDataURL(w)).then(w=>{g.uri=w}));let y=a.images.push(g)-1;return p[c]=y,y}else throw new Error("THREE.GLTFExporter: No valid image data found. Unable to process texture.")}processSampler(e){let t=this.json;t.samplers||(t.samplers=[]);let s={magFilter:I[e.magFilter],minFilter:I[e.minFilter],wrapS:I[e.wrapS],wrapT:I[e.wrapT]};return t.samplers.push(s)-1}async processTextureAsync(e){let t=this.options,s=this.cache,r=this.json;if(s.textures.has(e))return s.textures.get(e);r.textures||(r.textures=[]),e instanceof B&&(e=await this.decompressTextureAsync(e,t.maxTextureSize));let i=e.userData.mimeType;i==="image/webp"&&(i="image/png");let n={sampler:this.processSampler(e),source:this.processImage(e.image,e.format,e.flipY,i)};e.name&&(n.name=e.name),await this._invokeAllAsync(async function(l){l.writeTexture&&await l.writeTexture(e,n)});let a=r.textures.push(n)-1;return s.textures.set(e,a),a}async processMaterialAsync(e){let t=this.cache,s=this.json;if(t.materials.has(e))return t.materials.get(e);if(e.isShaderMaterial)return console.warn("GLTFExporter: THREE.ShaderMaterial not supported."),null;s.materials||(s.materials=[]);let r={pbrMetallicRoughness:{}};e.isMeshStandardMaterial!==!0&&e.isMeshBasicMaterial!==!0&&console.warn("GLTFExporter: Use MeshStandardMaterial or MeshBasicMaterial for best results.");let i=e.color.toArray().concat([e.opacity]);if(_(i,[1,1,1,1])||(r.pbrMetallicRoughness.baseColorFactor=i),e.isMeshStandardMaterial?(r.pbrMetallicRoughness.metallicFactor=e.metalness,r.pbrMetallicRoughness.roughnessFactor=e.roughness):(r.pbrMetallicRoughness.metallicFactor=0,r.pbrMetallicRoughness.roughnessFactor=1),e.metalnessMap||e.roughnessMap){let a=await this.buildMetalRoughTextureAsync(e.metalnessMap,e.roughnessMap),l={index:await this.processTextureAsync(a),texCoord:a.channel};this.applyTextureTransform(l,a),r.pbrMetallicRoughness.metallicRoughnessTexture=l}if(e.map){let a={index:await this.processTextureAsync(e.map),texCoord:e.map.channel};this.applyTextureTransform(a,e.map),r.pbrMetallicRoughness.baseColorTexture=a}if(e.emissive){let a=e.emissive;if(Math.max(a.r,a.g,a.b)>0&&(r.emissiveFactor=e.emissive.toArray()),e.emissiveMap){let l={index:await this.processTextureAsync(e.emissiveMap),texCoord:e.emissiveMap.channel};this.applyTextureTransform(l,e.emissiveMap),r.emissiveTexture=l}}if(e.normalMap){let a={index:await this.processTextureAsync(e.normalMap),texCoord:e.normalMap.channel};e.normalScale&&e.normalScale.x!==1&&(a.scale=e.normalScale.x),this.applyTextureTransform(a,e.normalMap),r.normalTexture=a}if(e.aoMap){let a={index:await this.processTextureAsync(e.aoMap),texCoord:e.aoMap.channel};e.aoMapIntensity!==1&&(a.strength=e.aoMapIntensity),this.applyTextureTransform(a,e.aoMap),r.occlusionTexture=a}e.transparent?r.alphaMode="BLEND":e.alphaTest>0&&(r.alphaMode="MASK",r.alphaCutoff=e.alphaTest),e.side===Re&&(r.doubleSided=!0),e.name!==""&&(r.name=e.name),this.serializeUserData(e,r),await this._invokeAllAsync(async function(a){a.writeMaterialAsync&&await a.writeMaterialAsync(e,r)});let n=s.materials.push(r)-1;return t.materials.set(e,n),n}async processMeshAsync(e){let t=this.cache,s=this.json,r=[e.geometry.uuid];if(Array.isArray(e.material))for(let f=0,T=e.material.length;f<T;f++)r.push(e.material[f].uuid);else r.push(e.material.uuid);let i=r.join(":");if(t.meshes.has(i))return t.meshes.get(i);let n=e.geometry,a;e.isLineSegments?a=d.LINES:e.isLineLoop?a=d.LINE_LOOP:e.isLine?a=d.LINE_STRIP:e.isPoints?a=d.POINTS:a=e.material.wireframe?d.LINES:d.TRIANGLES;let l={},h={},p=[],c=[],g={uv:"TEXCOORD_0",uv1:"TEXCOORD_1",uv2:"TEXCOORD_2",uv3:"TEXCOORD_3",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"},u=n.getAttribute("normal");u!==void 0&&!this.isNormalizedNormalAttribute(u)&&(console.warn("THREE.GLTFExporter: Creating normalized normal attribute from the non-normalized one."),n.setAttribute("normal",this.createNormalizedNormalAttribute(u)));let m=null;for(let f in n.attributes){if(f.slice(0,5)==="morph")continue;let T=n.attributes[f];if(f=g[f]||f.toUpperCase(),/^(POSITION|NORMAL|TANGENT|TEXCOORD_\d+|COLOR_\d+|JOINTS_\d+|WEIGHTS_\d+)$/.test(f)||(f="_"+f),t.attributes.has(this.getUID(T))){h[f]=t.attributes.get(this.getUID(T));continue}m=null;let M=T.array;f==="JOINTS_0"&&!(M instanceof Uint16Array)&&!(M instanceof Uint8Array)?(console.warn('GLTFExporter: Attribute "skinIndex" converted to type UNSIGNED_SHORT.'),m=new S(new Uint16Array(M),T.itemSize,T.normalized)):(M instanceof Uint32Array||M instanceof Int32Array)&&!f.startsWith("_")&&(console.warn('GLTFExporter: Attribute "'.concat(f,'" converted to type FLOAT.')),m=V.Utils.toFloat32BufferAttribute(T));let E=this.processAccessor(m||T,n);E!==null&&(f.startsWith("_")||this.detectMeshQuantization(f,T),h[f]=E,t.attributes.set(this.getUID(T),E))}if(u!==void 0&&n.setAttribute("normal",u),Object.keys(h).length===0)return null;if(e.morphTargetInfluences!==void 0&&e.morphTargetInfluences.length>0){let f=[],T=[],M={};if(e.morphTargetDictionary!==void 0)for(let E in e.morphTargetDictionary)M[e.morphTargetDictionary[E]]=E;for(let E=0;E<e.morphTargetInfluences.length;++E){let N={},X=!1;for(let F in n.morphAttributes){if(F!=="position"&&F!=="normal"){X||(console.warn("GLTFExporter: Only POSITION and NORMAL morph are supported."),X=!0);continue}let L=n.morphAttributes[F][E],G=F.toUpperCase(),U=n.attributes[F];if(t.attributes.has(this.getUID(L,!0))){N[G]=t.attributes.get(this.getUID(L,!0));continue}let C=L.clone();if(!n.morphTargetsRelative)for(let b=0,Te=L.count;b<Te;b++)for(let v=0;v<L.itemSize;v++)v===0&&C.setX(b,L.getX(b)-U.getX(b)),v===1&&C.setY(b,L.getY(b)-U.getY(b)),v===2&&C.setZ(b,L.getZ(b)-U.getZ(b)),v===3&&C.setW(b,L.getW(b)-U.getW(b));N[G]=this.processAccessor(C,n),t.attributes.set(this.getUID(U,!0),N[G])}c.push(N),f.push(e.morphTargetInfluences[E]),e.morphTargetDictionary!==void 0&&T.push(M[E])}l.weights=f,T.length>0&&(l.extras={},l.extras.targetNames=T)}let y=Array.isArray(e.material);if(y&&n.groups.length===0)return null;let w=!1;if(y&&n.index===null){let f=[];for(let T=0,M=n.attributes.position.count;T<M;T++)f[T]=T;n.setIndex(f),w=!0}let A=y?e.material:[e.material],R=y?n.groups:[{materialIndex:0,start:void 0,count:void 0}];for(let f=0,T=R.length;f<T;f++){let M={mode:a,attributes:h};if(this.serializeUserData(n,M),c.length>0&&(M.targets=c),n.index!==null){let N=this.getUID(n.index);(R[f].start!==void 0||R[f].count!==void 0)&&(N+=":"+R[f].start+":"+R[f].count),t.attributes.has(N)?M.indices=t.attributes.get(N):(M.indices=this.processAccessor(n.index,n,R[f].start,R[f].count),t.attributes.set(N,M.indices)),M.indices===null&&delete M.indices}let E=await this.processMaterialAsync(A[R[f].materialIndex]);E!==null&&(M.material=E),p.push(M)}w===!0&&n.setIndex(null),l.primitives=p,s.meshes||(s.meshes=[]),await this._invokeAllAsync(function(f){f.writeMesh&&f.writeMesh(e,l)});let O=s.meshes.push(l)-1;return t.meshes.set(i,O),O}detectMeshQuantization(e,t){if(this.extensionsUsed[P])return;let s;switch(t.array.constructor){case Int8Array:s="byte";break;case Uint8Array:s="unsigned byte";break;case Int16Array:s="short";break;case Uint16Array:s="unsigned short";break;default:return}t.normalized&&(s+=" normalized");let r=e.split("_",1)[0];W[r]&&W[r].includes(s)&&(this.extensionsUsed[P]=!0,this.extensionsRequired[P]=!0)}processCamera(e){let t=this.json;t.cameras||(t.cameras=[]);let s=e.isOrthographicCamera,r={type:s?"orthographic":"perspective"};return s?r.orthographic={xmag:e.right*2,ymag:e.top*2,zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near}:r.perspective={aspectRatio:e.aspect,yfov:H.degToRad(e.fov),zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near},e.name!==""&&(r.name=e.type),t.cameras.push(r)-1}processAnimation(e,t){let s=this.json,r=this.nodeMap;s.animations||(s.animations=[]),e=V.Utils.mergeMorphTargetTracks(e.clone(),t);let i=e.tracks,n=[],a=[];for(let l=0;l<i.length;++l){let h=i[l],p=D.parseTrackName(h.name),c=D.findNode(t,p.nodeName),g=Z[p.propertyName];if(p.objectName==="bones"&&(c.isSkinnedMesh===!0?c=c.skeleton.getBoneByName(p.objectIndex):c=void 0),!c||!g){console.warn('THREE.GLTFExporter: Could not export animation track "%s".',h.name);continue}let u=1,m=h.values.length/h.times.length;g===Z.morphTargetInfluences&&(m/=c.morphTargetInfluences.length);let y;h.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline===!0?(y="CUBICSPLINE",m/=3):h.getInterpolation()===Ne?y="STEP":y="LINEAR",a.push({input:this.processAccessor(new S(h.times,u)),output:this.processAccessor(new S(h.values,m)),interpolation:y}),n.push({sampler:a.length-1,target:{node:r.get(c),path:g}})}return s.animations.push({name:e.name||"clip_"+s.animations.length,samplers:a,channels:n}),s.animations.length-1}processSkin(e){let t=this.json,s=this.nodeMap,r=t.nodes[s.get(e)],i=e.skeleton;if(i===void 0)return null;let n=e.skeleton.bones[0];if(n===void 0)return null;let a=[],l=new Float32Array(i.bones.length*16),h=new Q;for(let p=0;p<i.bones.length;++p)a.push(s.get(i.bones[p])),h.copy(i.boneInverses[p]),h.multiply(e.bindMatrix).toArray(l,p*16);return t.skins===void 0&&(t.skins=[]),t.skins.push({inverseBindMatrices:this.processAccessor(new S(l,16)),joints:a,skeleton:s.get(n)}),r.skin=t.skins.length-1}async processNodeAsync(e){let t=this.json,s=this.options,r=this.nodeMap;t.nodes||(t.nodes=[]);let i={};if(s.trs){let a=e.quaternion.toArray(),l=e.position.toArray(),h=e.scale.toArray();_(a,[0,0,0,1])||(i.rotation=a),_(l,[0,0,0])||(i.translation=l),_(h,[1,1,1])||(i.scale=h)}else e.matrixAutoUpdate&&e.updateMatrix(),se(e.matrix)===!1&&(i.matrix=e.matrix.elements);if(e.name!==""&&(i.name=String(e.name)),this.serializeUserData(e,i),e.isMesh||e.isLine||e.isPoints){let a=await this.processMeshAsync(e);a!==null&&(i.mesh=a)}else e.isCamera&&(i.camera=this.processCamera(e));if(e.isSkinnedMesh&&this.skins.push(e),e.children.length>0){let a=[];for(let l=0,h=e.children.length;l<h;l++){let p=e.children[l];if(p.visible||s.onlyVisible===!1){let c=await this.processNodeAsync(p);c!==null&&a.push(c)}}a.length>0&&(i.children=a)}await this._invokeAllAsync(function(a){a.writeNode&&a.writeNode(e,i)});let n=t.nodes.push(i)-1;return r.set(e,n),n}async processSceneAsync(e){let t=this.json,s=this.options;t.scenes||(t.scenes=[],t.scene=0);let r={};e.name!==""&&(r.name=e.name),t.scenes.push(r);let i=[];for(let n=0,a=e.children.length;n<a;n++){let l=e.children[n];if(l.visible||s.onlyVisible===!1){let h=await this.processNodeAsync(l);h!==null&&i.push(h)}}i.length>0&&(r.nodes=i),this.serializeUserData(e,r)}async processObjectsAsync(e){let t=new q;t.name="AuxScene";for(let s=0;s<e.length;s++)t.children.push(e[s]);await this.processSceneAsync(t)}async processInputAsync(e){let t=this.options;e=e instanceof Array?e:[e],await this._invokeAllAsync(function(r){r.beforeParse&&r.beforeParse(e)});let s=[];for(let r=0;r<e.length;r++)e[r]instanceof q?await this.processSceneAsync(e[r]):s.push(e[r]);s.length>0&&await this.processObjectsAsync(s);for(let r=0;r<this.skins.length;++r)this.processSkin(this.skins[r]);for(let r=0;r<t.animations.length;++r)this.processAnimation(t.animations[r],e[0]);await this._invokeAllAsync(function(r){r.afterParse&&r.afterParse(e)})}async _invokeAllAsync(e){for(let t=0,s=this.plugins.length;t<s;t++)await e(this.plugins[t])}};x(ne,"GLTFWriter");var Ye=ne,ie=class{constructor(e){this.writer=e,this.name="KHR_lights_punctual"}writeNode(e,t){if(!e.isLight)return;if(!e.isDirectionalLight&&!e.isPointLight&&!e.isSpotLight){console.warn("THREE.GLTFExporter: Only directional, point, and spot lights are supported.",e);return}let s=this.writer,r=s.json,i=s.extensionsUsed,n={};e.name&&(n.name=e.name),n.color=e.color.toArray(),n.intensity=e.intensity,e.isDirectionalLight?n.type="directional":e.isPointLight?(n.type="point",e.distance>0&&(n.range=e.distance)):e.isSpotLight&&(n.type="spot",e.distance>0&&(n.range=e.distance),n.spot={},n.spot.innerConeAngle=(1-e.penumbra)*e.angle,n.spot.outerConeAngle=e.angle),e.decay!==void 0&&e.decay!==2&&console.warn("THREE.GLTFExporter: Light decay may be lost. glTF is physically-based, and expects light.decay=2."),e.target&&(e.target.parent!==e||e.target.position.x!==0||e.target.position.y!==0||e.target.position.z!==-1)&&console.warn("THREE.GLTFExporter: Light direction may be lost. For best results, make light.target a child of the light with position 0,0,-1."),i[this.name]||(r.extensions=r.extensions||{},r.extensions[this.name]={lights:[]},i[this.name]=!0);let a=r.extensions[this.name].lights;a.push(n),t.extensions=t.extensions||{},t.extensions[this.name]={light:a.length-1}}};x(ie,"GLTFLightExtension");var Ke=ie,ae=class{constructor(e){this.writer=e,this.name="KHR_materials_unlit"}async writeMaterialAsync(e,t){if(!e.isMeshBasicMaterial)return;let s=this.writer.extensionsUsed;t.extensions=t.extensions||{},t.extensions[this.name]={},s[this.name]=!0,t.pbrMetallicRoughness.metallicFactor=0,t.pbrMetallicRoughness.roughnessFactor=.9}};x(ae,"GLTFMaterialsUnlitExtension");var Xe=ae,oe=class{constructor(e){this.writer=e,this.name="KHR_materials_clearcoat"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||e.clearcoat===0)return;let s=this.writer,r=s.extensionsUsed,i={};if(i.clearcoatFactor=e.clearcoat,e.clearcoatMap){let n={index:await s.processTextureAsync(e.clearcoatMap),texCoord:e.clearcoatMap.channel};s.applyTextureTransform(n,e.clearcoatMap),i.clearcoatTexture=n}if(i.clearcoatRoughnessFactor=e.clearcoatRoughness,e.clearcoatRoughnessMap){let n={index:await s.processTextureAsync(e.clearcoatRoughnessMap),texCoord:e.clearcoatRoughnessMap.channel};s.applyTextureTransform(n,e.clearcoatRoughnessMap),i.clearcoatRoughnessTexture=n}if(e.clearcoatNormalMap){let n={index:await s.processTextureAsync(e.clearcoatNormalMap),texCoord:e.clearcoatNormalMap.channel};e.clearcoatNormalScale.x!==1&&(n.scale=e.clearcoatNormalScale.x),s.applyTextureTransform(n,e.clearcoatNormalMap),i.clearcoatNormalTexture=n}t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}};x(oe,"GLTFMaterialsClearcoatExtension");var qe=oe,le=class{constructor(e){this.writer=e,this.name="KHR_materials_dispersion"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||e.dispersion===0)return;let s=this.writer.extensionsUsed,r={};r.dispersion=e.dispersion,t.extensions=t.extensions||{},t.extensions[this.name]=r,s[this.name]=!0}};x(le,"GLTFMaterialsDispersionExtension");var We=le,ue=class{constructor(e){this.writer=e,this.name="KHR_materials_iridescence"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||e.iridescence===0)return;let s=this.writer,r=s.extensionsUsed,i={};if(i.iridescenceFactor=e.iridescence,e.iridescenceMap){let n={index:await s.processTextureAsync(e.iridescenceMap),texCoord:e.iridescenceMap.channel};s.applyTextureTransform(n,e.iridescenceMap),i.iridescenceTexture=n}if(i.iridescenceIor=e.iridescenceIOR,i.iridescenceThicknessMinimum=e.iridescenceThicknessRange[0],i.iridescenceThicknessMaximum=e.iridescenceThicknessRange[1],e.iridescenceThicknessMap){let n={index:await s.processTextureAsync(e.iridescenceThicknessMap),texCoord:e.iridescenceThicknessMap.channel};s.applyTextureTransform(n,e.iridescenceThicknessMap),i.iridescenceThicknessTexture=n}t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}};x(ue,"GLTFMaterialsIridescenceExtension");var Ze=ue,ce=class{constructor(e){this.writer=e,this.name="KHR_materials_transmission"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||e.transmission===0)return;let s=this.writer,r=s.extensionsUsed,i={};if(i.transmissionFactor=e.transmission,e.transmissionMap){let n={index:await s.processTextureAsync(e.transmissionMap),texCoord:e.transmissionMap.channel};s.applyTextureTransform(n,e.transmissionMap),i.transmissionTexture=n}t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}};x(ce,"GLTFMaterialsTransmissionExtension");var Je=ce,he=class{constructor(e){this.writer=e,this.name="KHR_materials_volume"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||e.transmission===0)return;let s=this.writer,r=s.extensionsUsed,i={};if(i.thicknessFactor=e.thickness,e.thicknessMap){let n={index:await s.processTextureAsync(e.thicknessMap),texCoord:e.thicknessMap.channel};s.applyTextureTransform(n,e.thicknessMap),i.thicknessTexture=n}e.attenuationDistance!==1/0&&(i.attenuationDistance=e.attenuationDistance),i.attenuationColor=e.attenuationColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}};x(he,"GLTFMaterialsVolumeExtension");var $e=he,pe=class{constructor(e){this.writer=e,this.name="KHR_materials_ior"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||e.ior===1.5)return;let s=this.writer.extensionsUsed,r={};r.ior=e.ior,t.extensions=t.extensions||{},t.extensions[this.name]=r,s[this.name]=!0}};x(pe,"GLTFMaterialsIorExtension");var Qe=pe,me=class{constructor(e){this.writer=e,this.name="KHR_materials_specular"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||e.specularIntensity===1&&e.specularColor.equals(Be)&&!e.specularIntensityMap&&!e.specularColorMap)return;let s=this.writer,r=s.extensionsUsed,i={};if(e.specularIntensityMap){let n={index:await s.processTextureAsync(e.specularIntensityMap),texCoord:e.specularIntensityMap.channel};s.applyTextureTransform(n,e.specularIntensityMap),i.specularTexture=n}if(e.specularColorMap){let n={index:await s.processTextureAsync(e.specularColorMap),texCoord:e.specularColorMap.channel};s.applyTextureTransform(n,e.specularColorMap),i.specularColorTexture=n}i.specularFactor=e.specularIntensity,i.specularColorFactor=e.specularColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}};x(me,"GLTFMaterialsSpecularExtension");var et=me,fe=class{constructor(e){this.writer=e,this.name="KHR_materials_sheen"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||e.sheen==0)return;let s=this.writer,r=s.extensionsUsed,i={};if(e.sheenRoughnessMap){let n={index:await s.processTextureAsync(e.sheenRoughnessMap),texCoord:e.sheenRoughnessMap.channel};s.applyTextureTransform(n,e.sheenRoughnessMap),i.sheenRoughnessTexture=n}if(e.sheenColorMap){let n={index:await s.processTextureAsync(e.sheenColorMap),texCoord:e.sheenColorMap.channel};s.applyTextureTransform(n,e.sheenColorMap),i.sheenColorTexture=n}i.sheenRoughnessFactor=e.sheenRoughness,i.sheenColorFactor=e.sheenColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}};x(fe,"GLTFMaterialsSheenExtension");var tt=fe,de=class{constructor(e){this.writer=e,this.name="KHR_materials_anisotropy"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||e.anisotropy==0)return;let s=this.writer,r=s.extensionsUsed,i={};if(e.anisotropyMap){let n={index:await s.processTextureAsync(e.anisotropyMap)};s.applyTextureTransform(n,e.anisotropyMap),i.anisotropyTexture=n}i.anisotropyStrength=e.anisotropy,i.anisotropyRotation=e.anisotropyRotation,t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}};x(de,"GLTFMaterialsAnisotropyExtension");var st=de,ge=class{constructor(e){this.writer=e,this.name="KHR_materials_emissive_strength"}async writeMaterialAsync(e,t){if(!e.isMeshStandardMaterial||e.emissiveIntensity===1)return;let s=this.writer.extensionsUsed,r={};r.emissiveStrength=e.emissiveIntensity,t.extensions=t.extensions||{},t.extensions[this.name]=r,s[this.name]=!0}};x(ge,"GLTFMaterialsEmissiveStrengthExtension");var rt=ge,ye=class{constructor(e){this.writer=e,this.name="EXT_materials_bump"}async writeMaterialAsync(e,t){if(!e.isMeshStandardMaterial||e.bumpScale===1&&!e.bumpMap)return;let s=this.writer,r=s.extensionsUsed,i={};if(e.bumpMap){let n={index:await s.processTextureAsync(e.bumpMap),texCoord:e.bumpMap.channel};s.applyTextureTransform(n,e.bumpMap),i.bumpTexture=n}i.bumpFactor=e.bumpScale,t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}};x(ye,"GLTFMaterialsBumpExtension");var nt=ye,xe=class{constructor(e){this.writer=e,this.name="EXT_mesh_gpu_instancing"}writeNode(e,t){if(!e.isInstancedMesh)return;let s=this.writer,r=e,i=new Float32Array(r.count*3),n=new Float32Array(r.count*4),a=new Float32Array(r.count*3),l=new Q,h=new k,p=new Me,c=new k;for(let u=0;u<r.count;u++)r.getMatrixAt(u,l),l.decompose(h,p,c),h.toArray(i,u*3),p.toArray(n,u*4),c.toArray(a,u*3);let g={TRANSLATION:s.processAccessor(new S(i,3)),ROTATION:s.processAccessor(new S(n,4)),SCALE:s.processAccessor(new S(a,3))};r.instanceColor&&(g._COLOR_0=s.processAccessor(r.instanceColor)),t.extensions=t.extensions||{},t.extensions[this.name]={attributes:g},s.extensionsUsed[this.name]=!0,s.extensionsRequired[this.name]=!0}};x(xe,"GLTFMeshGpuInstancing");var it=xe;V.Utils={insertKeyframe:x(function(o,e){let t=o.getValueSize(),s=new o.TimeBufferType(o.times.length+1),r=new o.ValueBufferType(o.values.length+t),i=o.createInterpolant(new o.ValueBufferType(t)),n;if(o.times.length===0){s[0]=e;for(let a=0;a<t;a++)r[a]=0;n=0}else if(e<o.times[0]){if(Math.abs(o.times[0]-e)<.001)return 0;s[0]=e,s.set(o.times,1),r.set(i.evaluate(e),0),r.set(o.values,t),n=0}else if(e>o.times[o.times.length-1]){if(Math.abs(o.times[o.times.length-1]-e)<.001)return o.times.length-1;s[s.length-1]=e,s.set(o.times,0),r.set(o.values,0),r.set(i.evaluate(e),o.values.length),n=s.length-1}else for(let a=0;a<o.times.length;a++){if(Math.abs(o.times[a]-e)<.001)return a;if(o.times[a]<e&&o.times[a+1]>e){s.set(o.times.slice(0,a+1),0),s[a+1]=e,s.set(o.times.slice(a+1),a+2),r.set(o.values.slice(0,(a+1)*t),0),r.set(i.evaluate(e),(a+1)*t),r.set(o.values.slice((a+1)*t),(a+2)*t),n=a+1;break}}return o.times=s,o.values=r,n},"insertKeyframe"),mergeMorphTargetTracks:x(function(o,e){let t=[],s={},r=o.tracks;for(let i=0;i<r.length;++i){let n=r[i],a=D.parseTrackName(n.name),l=D.findNode(e,a.nodeName);if(a.propertyName!=="morphTargetInfluences"||a.propertyIndex===void 0){t.push(n);continue}if(n.createInterpolant!==n.InterpolantFactoryMethodDiscrete&&n.createInterpolant!==n.InterpolantFactoryMethodLinear){if(n.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline)throw new Error("THREE.GLTFExporter: Cannot merge tracks with glTF CUBICSPLINE interpolation.");console.warn("THREE.GLTFExporter: Morph target interpolation mode not yet supported. Using LINEAR instead."),n=n.clone(),n.setInterpolation(Ge)}let h=l.morphTargetInfluences.length,p=l.morphTargetDictionary[a.propertyIndex];if(p===void 0)throw new Error("THREE.GLTFExporter: Morph target name not found: "+a.propertyIndex);let c;if(s[l.uuid]===void 0){c=n.clone();let u=new c.ValueBufferType(h*c.times.length);for(let m=0;m<c.times.length;m++)u[m*h+p]=c.values[m];c.name=(a.nodeName||"")+".morphTargetInfluences",c.values=u,s[l.uuid]=c,t.push(c);continue}let g=n.createInterpolant(new n.ValueBufferType(1));c=s[l.uuid];for(let u=0;u<c.times.length;u++)c.values[u*h+p]=g.evaluate(c.times[u]);for(let u=0;u<n.times.length;u++){let m=this.insertKeyframe(c,n.times[u]);c.values[m*h+p]=n.values[u]}}return o.tracks=t,o},"mergeMorphTargetTracks"),toFloat32BufferAttribute:x(function(o){let e=new S(new Float32Array(o.count*o.itemSize),o.itemSize,!1);if(!o.normalized&&!o.isInterleavedBufferAttribute)return e.array.set(o.array),e;for(let t=0,s=o.count;t<s;t++)for(let r=0;r<o.itemSize;r++)e.setComponent(t,r,o.getComponent(t,r));return e},"toFloat32BufferAttribute")};export{V as GLTFExporter};
